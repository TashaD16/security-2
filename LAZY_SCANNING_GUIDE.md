# Руководство по использованию модуля gateway_lazy (ленивое сканирование)

## Описание

Модуль `gateway_lazy` предоставляет ленивое сканирование эндпоинтов - сканирует конкретный эндпоинт при первом обращении к нему, а не все эндпоинты при старте приложения. Это ускоряет старт приложения и экономит ресурсы.

**ВАЖНО:** Ленивое сканирование реализовано в отдельном модуле `gateway_lazy`. Используйте этот модуль вместо `gateway`, если вам нужно ленивое сканирование.

## Преимущества

1. **Быстрый старт** - приложение запускается быстрее, так как не сканирует все контроллеры
2. **Экономия ресурсов** - сканируются только те эндпоинты, к которым действительно обращаются
3. **Динамическое добавление** - новые эндпоинты автоматически сканируются при первом обращении
4. **Кэширование** - отсканированные эндпоинты кэшируются, повторное сканирование не требуется

## Как это работает

```
1. Запрос приходит к эндпоинту: GET /api/declarations
2. AnnotationBasedAuthorizationChecker проверяет наличие правила в реестре
3. Если правило не найдено и включено ленивое сканирование:
   → LazyEndpointScanner ищет контроллер, содержащий этот эндпоинт
   → Сканирует только этот контроллер
   → Регистрирует все эндпоинты этого контроллера в реестре
   → Кэширует результат
4. Проверка авторизации выполняется с найденным правилом
```

## Настройка

### 1. Добавьте зависимость на gateway_lazy

В `pom.xml` вашего проекта:

```xml
<dependency>
    <groupId>com.example</groupId>
    <artifactId>gateway_lazy</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 2. Настройте пакеты для сканирования

В `application.properties`:

```properties
# Пакеты для сканирования контроллеров (разделенные запятой)
endpoint-scanner.scan-packages=com.yourproject.module1.controller,com.yourproject.module2.controller

# Автоматическое сканирование всего classpath при поиске контроллера
# Если true, при поиске контроллера для эндпоинта будет сканироваться весь classpath
# Если false, будут сканироваться только указанные пакеты
endpoint-scanner.lazy.auto-scan-all=false
```

**ВАЖНО:** В модуле `gateway_lazy` сканирование при старте отключено по умолчанию. Эндпоинты сканируются автоматически при первом обращении к ним.

## Сравнение модулей

### Модуль gateway (обычное сканирование)

**Поведение:**
- При старте приложения сканируются все контроллеры
- Все эндпоинты регистрируются в реестре
- Первое обращение к эндпоинту быстрее (правило уже в реестре)
- Старт приложения медленнее

**Когда использовать:**
- Небольшое количество контроллеров
- Нужна максимальная производительность при первом обращении
- Все эндпоинты известны заранее

### Модуль gateway_lazy (ленивое сканирование)

**Поведение:**
- При старте приложения контроллеры не сканируются
- Эндпоинты сканируются при первом обращении к ним
- Первое обращение к эндпоинту медленнее (нужно отсканировать)
- Последующие обращения быстрые (результат кэширован)
- Старт приложения быстрее

**Когда использовать:**
- Большое количество контроллеров
- Не все эндпоинты используются сразу
- Нужен быстрый старт приложения
- Эндпоинты добавляются динамически

## Примеры использования

### Пример 1: Ленивое сканирование с указанными пакетами

```properties
endpoint-scanner.lazy.auto-scan-all=false
endpoint-scanner.scan-packages=com.yourproject.module1.controller,com.yourproject.module2.controller
```

При обращении к эндпоинту будет сканироваться только указанные пакеты для поиска контроллера.

### Пример 2: Ленивое сканирование всего classpath

```properties
endpoint-scanner.lazy.auto-scan-all=true
```

При обращении к эндпоинту будет сканироваться весь classpath для поиска контроллера (медленнее, но надежнее).

## Логирование

При ленивом сканировании в логах будет видно:

```
DEBUG - Checking authorization for GET /api/declarations
DEBUG - Authorization method not found, attempting lazy scan for GET /api/declarations
DEBUG - Lazy scanning endpoint: GET /api/declarations
INFO  - Lazy scanned controller DeclarationController for endpoint GET /api/declarations, registered 5 rules
DEBUG - Found authorization method for GET /api/declarations
```

## Кэширование

Ленивый сканер использует два уровня кэширования:

1. **Кэш отсканированных контроллеров** - путь → класс контроллера
2. **Кэш проверенных путей** - список путей, которые уже проверялись

Это означает:
- Контроллер сканируется только один раз
- Путь проверяется только один раз
- Повторные обращения к эндпоинту не требуют сканирования

## Производительность

### Первое обращение к эндпоинту (ленивое сканирование)

```
1. Поиск контроллера: ~10-50ms (зависит от количества контроллеров)
2. Сканирование контроллера: ~1-5ms
3. Регистрация правил: ~1ms
Итого: ~12-56ms
```

### Последующие обращения

```
1. Поиск правила в реестре: ~0.1ms
Итого: ~0.1ms (как при обычном сканировании)
```

### Старт приложения

**Обычное сканирование:**
- Сканирование всех контроллеров: ~100-500ms (зависит от количества)
- Старт приложения: медленнее

**Ленивое сканирование:**
- Сканирование при старте: 0ms
- Старт приложения: быстрее

## Рекомендации

1. **Используйте модуль gateway_lazy**, если:
   - У вас много контроллеров
   - Не все эндпоинты используются сразу
   - Нужен быстрый старт приложения

2. **Используйте модуль gateway**, если:
   - У вас мало контроллеров
   - Все эндпоинты используются сразу
   - Нужна максимальная производительность при первом обращении

## Отладка

Если эндпоинт не находится при ленивом сканировании:

1. Проверьте логи на наличие ошибок сканирования
2. Убедитесь, что контроллер имеет аннотацию `@RestController`
3. Проверьте, что путь эндпоинта совпадает с путем в контроллере
4. Убедитесь, что пакеты указаны правильно (если `auto-scan-all=false`)
5. Проверьте, что метод имеет аннотацию безопасности (`@RequireReadDeclaration`, etc.)

## API

### LazyEndpointScanner.scanEndpointOnDemand()

```java
boolean scanEndpointOnDemand(String httpMethod, String path)
```

Сканирует конкретный эндпоинт при обращении к нему.

**Параметры:**
- `httpMethod` - HTTP метод (GET, POST, PUT, DELETE, PATCH)
- `path` - путь эндпоинта

**Возвращает:**
- `true` если эндпоинт найден и зарегистрирован
- `false` если эндпоинт не найден

## Резюме

✅ Ленивое сканирование ускоряет старт приложения  
✅ Эндпоинты сканируются только при обращении к ним  
✅ Результаты кэшируются для быстрого доступа  
✅ Поддерживает сканирование по пакетам или всего classpath  
✅ Работает автоматически при включении в конфигурации  
